/*
 * generated by Xtext
 */
package at.ac.tuwien.big.forms.form.scoping;

import java.util.ArrayList;
import java.util.HashSet;

import org.apache.log4j.Logger;
import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.xtext.scoping.IScope;
import org.eclipse.xtext.scoping.Scopes;

import at.ac.tuwien.big.forms.Attribute;
import at.ac.tuwien.big.forms.AttributePageElement;
import at.ac.tuwien.big.forms.AttributeType;
import at.ac.tuwien.big.forms.Entity;
import at.ac.tuwien.big.forms.Feature;
import at.ac.tuwien.big.forms.Form;
import at.ac.tuwien.big.forms.FormModel;
import at.ac.tuwien.big.forms.FormsPackage;
import at.ac.tuwien.big.forms.List;
import at.ac.tuwien.big.forms.Page;
import at.ac.tuwien.big.forms.Relationship;
import at.ac.tuwien.big.forms.RelationshipPageElement;
import at.ac.tuwien.big.forms.SelectionField;

/**
 * This class contains custom scoping description.
 * 
 * see : http://www.eclipse.org/Xtext/documentation.html#scoping
 * on how and when to use it 
 *
 */
public class FormScopeProvider extends org.eclipse.xtext.scoping.impl.AbstractDeclarativeScopeProvider {

	public IScope getScope(EObject context, EReference reference) {
		//log.info("getScope: context: "+context+" reference: "+reference);
		return super.getScope(context, reference);
	}
	// Wer macht was
	//TODO: Tyler 1,3
	//TODO: Clemente 2,5
	IScope scope_RelationshipPageElement_editingForm(RelationshipPageElement rpe, EReference ref) {
		if (ref.equals(FormsPackage.Literals.RELATIONSHIP_PAGE_ELEMENT__EDITING_FORM)) {
			ArrayList<EObject> elements = new ArrayList<EObject>();
			EObject eo_page = rpe.eContainer();
			if (eo_page instanceof Page) {
				//logger.info("eo_page is a Page: "+eo_page);
				Page page = (Page)eo_page;
				EObject eo_form = page.eContainer();
				if (eo_form instanceof Form) {
					EObject eo_model = eo_form.eContainer();
					if (eo_model instanceof FormModel) {
						FormModel fm = (FormModel)eo_model;
						for (Form form : fm.getForms()) {
							if (!form.equals((Form)eo_form)) {
								elements.add(form);
							}
						}
					}else {
						logger.error("eo_model not a FormModel: "+eo_form);
						return IScope.NULLSCOPE;
					}
					
				} else {
					logger.error("eo_form not a Form: "+eo_form);
					return IScope.NULLSCOPE;
				}
			} else {
				logger.error("eo_page not a Page: "+eo_page);
				return IScope.NULLSCOPE;
			}
			//logger.info("END");
			return Scopes.scopeFor(elements);
		} else {
			logger.info("scope_RelationshipPageElement_editingForm NULLSCOPE");
			return IScope.NULLSCOPE;
		}
	}
	
	IScope scope_RelationshipPageElement_relationship(RelationshipPageElement rpe, EReference ref) {
		//logger.info("scope_RelationshipPageElement_relationship: "+rpe.getElementID());
		if (ref.equals(FormsPackage.Literals.RELATIONSHIP_PAGE_ELEMENT__RELATIONSHIP)) {
			ArrayList<EObject> elements = new ArrayList<EObject>();
			EObject eo_page = rpe.eContainer();
			if (eo_page instanceof Page) {
				//logger.info("eo_page is a Page: "+eo_page);
				Page page = (Page)eo_page;
				EObject eo_form = page.eContainer();
				if (eo_form instanceof Form) {
					//logger.info("eo_form is a Form: "+eo_page);
					Form form = (Form)eo_form;
					for (Feature feature :form.getEntity().getFeatures()) {
						if (feature instanceof Relationship) {
							elements.add(feature);
						}
					}
					
					//return IScope.NULLSCOPE;
				} else {
					logger.error("eo_form not a Form: "+eo_form);
					return IScope.NULLSCOPE;
				}
			} else {
				logger.error("eo_page not a Page: "+eo_page);
				return IScope.NULLSCOPE;
			}
			//logger.info("END");
			return Scopes.scopeFor(elements);
		} else {
			logger.info("scope_RelationshipPageElement_relationship NULLSCOPE");
			return IScope.NULLSCOPE;
		}
	}
	//TODO: Lukas 4,6
	
	/* 4 - A selection field is only allowed to reference an attribute of type Boolean or an attribute 
	which has a reference to an enumeration.
	Example: The selection-field ExternalPersonSelection in page "Person Details" is only allowed to 
	reference the attributes external and faculty of the entity Person
	*/
	
	IScope scope_AttributePageElement_attribute(SelectionField sf, EReference ref){
		if (ref.equals(FormsPackage.Literals.ATTRIBUTE_PAGE_ELEMENT__ATTRIBUTE)){
			ArrayList<EObject> elements = new ArrayList<EObject>();
			EObject eo_page = sf.eContainer();
			if (eo_page instanceof Page) {
				//logger.info("eo_page is a Page: "+eo_page);
				Page page = (Page)eo_page;
				EObject eo_form = page.eContainer();
				if (eo_form instanceof Form) {
					Form form = (Form) eo_form;
					for (Feature feature :form.getEntity().getFeatures()) {
						if (feature instanceof  Attribute ) {
							Attribute attribute = (Attribute) feature;
							if (attribute.getType().equals(AttributeType.BOOLEAN)) {
								elements.add(attribute);
							} else if (attribute.getType().equals(AttributeType.NONE) && 
									   !(attribute.getEnumeration().equals(null))){
								elements.add(attribute);
							}
						}
						}
					}				
				}	
			
			return Scopes.scopeFor(elements);
		} else {
			logger.info("scope_AttributePageElement_attribute NULLSCOPE");
			return IScope.NULLSCOPE;
		}
	}
	
	
}
